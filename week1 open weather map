import requests
import tkinter as tk
from tkinter import messagebox
import sqlite3
from datetime import datetime

# Database setup for storing operation history
def setup_database():
    conn = sqlite3.connect('weather_history.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS history (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        location TEXT,
                        temperature TEXT,
                        humidity TEXT,
                        wind_speed TEXT,
                        timestamp TEXT
                    )''')
    conn.commit()
    conn.close()

# Function to save operation history
def save_to_database(location, temperature, humidity, wind_speed):
    conn = sqlite3.connect('weather_history.db')
    cursor = conn.cursor()
    cursor.execute('''INSERT INTO history (location, temperature, humidity, wind_speed, timestamp)
                      VALUES (?, ?, ?, ?, ?)''',
                   (location, temperature, humidity, wind_speed, datetime.now().strftime('%Y-%m-%d %H:%M:%S')))
    conn.commit()
    conn.close()

# Function to fetch weather data from OpenWeatherMap API
def get_weather_data(location):
    api_key = '641536db3ec8eba03adaaa4ce5f8075e'  # Replace with your valid API key
    base_url = 'https://api.openweathermap.org/data/2.5/weather'

    params = {
        'q': location,
        'appid': api_key,
        'units': 'metric'  # Fetch data in Celsius
    }

    try:
        response = requests.get(base_url, params=params)
        response.raise_for_status()  # Raise HTTPError for bad responses
        data = response.json()
        weather_info = {
            'temperature': data['main']['temp'],
            'humidity': data['main']['humidity'],
            'wind_speed': data['wind']['speed']
        }
        return weather_info
    except requests.exceptions.RequestException:
        return None

# Function to display weather data in the GUI
def display_weather():
    location = location_entry.get().strip()  # Strip whitespace from input
    if not location:
        messagebox.showerror("Error", "Please enter a location.")
        return

    # Clear previous data
    temperature_label.config(text="Temperature: ")
    humidity_label.config(text="Humidity: ")
    wind_speed_label.config(text="Wind Speed: ")

    weather_data = get_weather_data(location)
    if weather_data:
        temperature_label.config(text=f"Temperature: {weather_data['temperature']} \u00b0C")
        humidity_label.config(text=f"Humidity: {weather_data['humidity']}%")
        wind_speed_label.config(text=f"Wind Speed: {weather_data['wind_speed']} m/s")
        save_to_database(location, weather_data['temperature'], weather_data['humidity'], weather_data['wind_speed'])
    else:
        messagebox.showerror("Error", "Could not fetch weather data. Check the location or API key.")

# Function to clear input and output fields
def clear_fields():
    location_entry.delete(0, tk.END)
    temperature_label.config(text="Temperature: ")
    humidity_label.config(text="Humidity: ")
    wind_speed_label.config(text="Wind Speed: ")

# Tkinter GUI setup
setup_database()
root = tk.Tk()
root.title("Weather Application")
root.geometry("400x350")

# Input field
location_label = tk.Label(root, text="Enter Location:")
location_label.pack(pady=10)

location_entry = tk.Entry(root, width=30)
location_entry.pack(pady=5)

# Buttons
button_frame = tk.Frame(root)
button_frame.pack(pady=10)

fetch_button = tk.Button(button_frame, text="Get Weather", command=display_weather)
fetch_button.grid(row=0, column=0, padx=10)

clear_button = tk.Button(button_frame, text="Clear", command=clear_fields)
clear_button.grid(row=0, column=1, padx=10)

quit_button = tk.Button(button_frame, text="Quit", command=root.quit)
quit_button.grid(row=0, column=2, padx=10)

# Weather information labels
temperature_label = tk.Label(root, text="Temperature: ", font=("Arial", 12))
temperature_label.pack(pady=5)

humidity_label = tk.Label(root, text="Humidity: ", font=("Arial", 12))
humidity_label.pack(pady=5)

wind_speed_label = tk.Label(root, text="Wind Speed: ", font=("Arial", 12))
wind_speed_label.pack(pady=5)

root.mainloop()
